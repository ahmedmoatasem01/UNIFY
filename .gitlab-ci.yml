# GitLab CI/CD Pipeline Configuration
# For GitLab.com or self-hosted GitLab

stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE_NAME: unify-app
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_IMAGE_TAG: $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME

# ============================================
# Code Quality & Linting
# ============================================
lint:
  stage: lint
  image: python:3.11-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install flake8 black isort
  script:
    - black --check --diff src/ tests/
    - isort --check-only --diff src/ tests/
    - flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# Unit & Integration Tests
# ============================================
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r deployment/requirements.txt
    - pip install pytest pytest-cov pytest-flask
  script:
    - pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - htmlcov/
    expire_in: 30 days
  only:
    - merge_requests
    - main
    - develop

# ============================================
# Security Scanning
# ============================================
security-scan:
  stage: security
  image: python:3.11-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install bandit safety
    - pip install -r deployment/requirements.txt
  script:
    - bandit -r src/ -ll -f json -o bandit-report.json || true
    - safety check --json --output safety-report.json || true
    - bandit -r src/ -ll
    - safety check
  artifacts:
    paths:
      - bandit-report.json
      - safety-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# Docker Build
# ============================================
build-docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        --file deployment/Dockerfile \
        --tag $DOCKER_IMAGE_TAG:$CI_COMMIT_REF_SLUG \
        --tag $DOCKER_IMAGE_TAG:latest \
        .
    - docker push $DOCKER_IMAGE_TAG:$CI_COMMIT_REF_SLUG
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker push $DOCKER_IMAGE_TAG:latest
      fi
  only:
    - main
    - develop
    - merge_requests

# ============================================
# Docker Security Scan
# ============================================
docker-security:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - build-docker
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --format table $DOCKER_IMAGE_TAG:$CI_COMMIT_REF_SLUG
    - trivy image --exit-code 1 --severity CRITICAL --format json -o trivy-report.json $DOCKER_IMAGE_TAG:$CI_COMMIT_REF_SLUG || true
  artifacts:
    paths:
      - trivy-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - main
    - develop

# ============================================
# Deploy to Staging
# ============================================
deploy-staging:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  environment:
    name: staging
    url: https://staging.unify.example.com
  script:
    - echo "Deploying to staging..."
    - |
      # Add your staging deployment commands here
      # Example: kubectl, docker-compose, or cloud provider CLI
      docker pull $DOCKER_IMAGE_TAG:develop
      # docker-compose -f deployment/docker-compose.yml up -d
  only:
    - develop
  when: manual
  allow_failure: true

# ============================================
# Deploy to Production
# ============================================
deploy-production:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  environment:
    name: production
    url: https://unify.example.com
  script:
    - echo "Deploying to production..."
    - |
      # Add your production deployment commands here
      docker pull $DOCKER_IMAGE_TAG:main
      # Run database migrations
      # Update docker-compose or Kubernetes
      # Verify deployment
  only:
    - main
  when: manual
  only:
    variables:
      - $CI_COMMIT_BRANCH == "main"

