<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unify | Course Registration</title>
    <link rel="stylesheet" href="../static/styles/course_registration.css">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="cr-body">
<div class="cr-app-layout">

    <!-- ===== Sidebar ===== -->
    <aside class="cr-sidebar">
        <div class="cr-sidebar-header">
            <div class="cr-brand-logo">U</div>
            <div>
                <h2 class="cr-brand-title">Unify</h2>
                <p class="cr-brand-subtitle">Student Assistant</p>
            </div>
        </div>

        <nav class="cr-sidebar-nav">
            <a class="cr-nav-item" href="/overview">
                <i class="fa-solid fa-chart-column"></i>
                <span>Overview</span>
            </a>
            <a class="cr-nav-item" href="/schedule">
                <i class="fa-solid fa-calendar-day"></i>
                <span>Schedule</span>
            </a>
            <a class="cr-nav-item" href="/tasks">
                <i class="fa-solid fa-list-check"></i>
                <span>Tasks</span>
            </a>
            <a class="cr-nav-item" href="/notes">
                <i class="fa-solid fa-note-sticky"></i>
                <span>Notes &amp; Summaries</span>
            </a>
            <a class="cr-nav-item" href="/calendar">
                <i class="fa-solid fa-bell"></i>
                <span>Calendar &amp; Reminders</span>
            </a>
            <a class="cr-nav-item" href="/messages">
                <i class="fa-solid fa-message"></i>
                <span>Messages</span>
            </a>
            <a class="cr-nav-item" href="/transcript">
                <i class="fa-solid fa-file-lines"></i>
                <span>Transcript</span>
            </a>
            <a class="cr-nav-item active" href="/course-registration">
                <i class="fa-solid fa-book-open"></i>
                <span>Course Registration</span>
            </a>
            <a class="cr-nav-item" href="/settings">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </a>
        </nav>

        <div class="cr-sidebar-footer">
            <button class="cr-btn-ghost cr-logout-btn" onclick="handleLogout()">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span>Log out</span>
            </button>
            <p class="cr-small-text">CSAI 203 ¬∑ Team 5</p>
        </div>
    </aside>

    <!-- ===== Main panel ===== -->
    <div class="cr-main-panel">
        <!-- Top navbar -->
        <header class="cr-topbar">
            <div class="cr-topbar-left">
                <h1><i class="fa-solid fa-graduation-cap"></i> Course Registration</h1>
                <p>Search courses, add them to your cart, and let the AI optimizer choose a conflict-free schedule.</p>
            </div>
            <div class="cr-topbar-right">
                <button id="cr-theme-toggle" class="cr-icon-btn" title="Toggle light/dark mode">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <div class="cr-user-chip">
                    <div class="cr-avatar">{{ user_data.avatar_letter if user_data else 'U' }}</div>
                    <div>
                        <p class="cr-user-name">{{ user_data.name if user_data else 'User' }}</p>
                        <p class="cr-user-role">{{ user_data.role if user_data else 'User' }} ¬∑ {{ user_data.department if user_data else 'Zewail City' }}</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="cr-main">
            <!-- Top row: search + cart -->
            <section class="cr-grid-2">
                <!-- Search + results -->
                <div class="cr-panel cr-panel-animated">
                    <h2><i class="fa-solid fa-magnifying-glass"></i> Search Courses</h2>
                    <p class="cr-muted">Search by course code or name (e.g., AIE 501, CSAI 203, Mechatronics).</p>

                    <div class="cr-search-row">
                        <input type="text" id="cr-search-input" placeholder="Type to search...">
                        <button id="cr-search-btn" class="cr-btn-primary-outline">
                            <i class="fa-solid fa-magnifying-glass"></i> Search
                        </button>
                    </div>

                    <div id="cr-courses-list" class="cr-course-list">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Cart + optimizer -->
                <div class="cr-panel cr-panel-animated">
                    <h2><i class="fa-solid fa-cart-plus"></i> Selected Courses</h2>
                    <p id="cr-cart-empty" class="cr-muted">
                        No courses selected yet. Search on the left and click ‚ÄúAdd‚Äù.
                    </p>

                    <ul id="cr-cart-list" class="cr-cart-list"></ul>

                    <button id="cr-optimize-btn" class="cr-btn-primary" disabled>
                        <i class="fa-solid fa-robot"></i> Run AI Schedule Optimizer
                    </button>

                    <button id="cr-enroll-btn" class="cr-btn-primary" style="display: none; margin-top: 10px;">
                        <i class="fa-solid fa-save"></i> Save & Enroll in Selected Courses
                    </button>

                    <p id="cr-optimize-status" class="cr-status-text"></p>
                </div>
            </section>

            <!-- Bottom row: timetable + calendar -->
            <section class="cr-grid-2 cr-mt">
                <!-- List view -->
                <div class="cr-panel cr-panel-animated">
                    <h2><i class="fa-solid fa-list"></i> Optimized Timetable</h2>
                    <table class="cr-table" id="cr-schedule-table">
                        <thead>
                        <tr>
                            <th>Course</th>
                            <th>Type</th>
                            <th>Sub-Type</th>
                            <th>Section</th>
                            <th>Day</th>
                            <th>Start</th>
                            <th>End</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Weekly calendar -->
                <div class="cr-panel cr-panel-animated">
                    <h2><i class="fa-solid fa-calendar-week"></i> Weekly Calendar View</h2>
                    <p class="cr-muted">Visual layout of your optimized schedule (like Google Calendar).</p>
                    <div class="cr-calendar-wrapper cr-mt">
                        <div id="cr-calendar-grid" class="cr-calendar-grid">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<script>
    // =============== THEME TOGGLE (LIGHT / DARK) ===============
    const crThemeToggle = document.getElementById('cr-theme-toggle');

    function crApplySavedTheme() {
        const saved = localStorage.getItem('unify_cr_theme') || 'dark';
        if (saved === 'light') {
            document.body.classList.add('cr-light-mode');
            crThemeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
        } else {
            document.body.classList.remove('cr-light-mode');
            crThemeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
        }
    }

    crThemeToggle.addEventListener('click', () => {
        document.body.classList.toggle('cr-light-mode');
        const isLight = document.body.classList.contains('cr-light-mode');
        localStorage.setItem('unify_cr_theme', isLight ? 'light' : 'dark');
        crThemeToggle.innerHTML = isLight
            ? '<i class="fa-solid fa-sun"></i>'
            : '<i class="fa-solid fa-moon"></i>';
    });

    crApplySavedTheme();

    // =============== DOM ELEMENTS ===============
    const crCoursesListEl    = document.getElementById('cr-courses-list');
    const crSearchInput      = document.getElementById('cr-search-input');
    const crSearchBtn        = document.getElementById('cr-search-btn');
    const crCartListEl       = document.getElementById('cr-cart-list');
    const crCartEmptyEl      = document.getElementById('cr-cart-empty');
    const crOptimizeBtn      = document.getElementById('cr-optimize-btn');
    const crEnrollBtn        = document.getElementById('cr-enroll-btn');
    const crOptimizeStatusEl = document.getElementById('cr-optimize-status');
    const crScheduleTableBody= document.querySelector('#cr-schedule-table tbody');
    const crCalendarGridEl   = document.getElementById('cr-calendar-grid');

    let crCurrentCourses = [];
    let crCartCourseIds  = [];
    let crCurrentSchedule = [];  // Store current optimized schedule

    // =============== RENDER COURSES (SEARCH RESULTS) ===============
    function crRenderCourses() {
        crCoursesListEl.innerHTML = '';

        if (crCurrentCourses.length === 0) {
            crCoursesListEl.innerHTML = '<p class="cr-muted">No courses found.</p>';
            return;
        }

        crCurrentCourses.forEach(course => {
            const card = document.createElement('div');
            card.className = 'cr-course-card';

            const inCart = crCartCourseIds.includes(course.id);
            const lectureCount = (course.lecture_slots || []).length;
            const labCount     = (course.lab_slots || []).length;

            card.innerHTML = `
                <div class="cr-course-info">
                    <h3><i class="fa-solid fa-book-open"></i> ${course.code} ‚Äì ${course.name}</h3>
                    <p class="cr-course-meta">
                        <strong>Lectures:</strong> ${lectureCount}
                        &nbsp;|&nbsp;
                        <strong>Labs/Tutorials:</strong> ${labCount}
                    </p>
                </div>
                <div class="cr-course-actions">
                    <button class="cr-btn-secondary" ${inCart ? 'disabled' : ''}>
                        ${inCart ? '<i class="fa-solid fa-check"></i> Added' : '<i class="fa-solid fa-plus"></i> Add'}
                    </button>
                </div>
            `;

            const btn = card.querySelector('button');
            btn.addEventListener('click', () => {
                crAddToCart(course.id);
            });

            crCoursesListEl.appendChild(card);
        });
    }

    // =============== RENDER CART ===============
    function crRenderCart() {
        crCartListEl.innerHTML = '';

        if (crCartCourseIds.length === 0) {
            crCartEmptyEl.style.display = 'block';
            crCartEmptyEl.textContent = 'No courses selected yet. Search and click ‚ÄúAdd‚Äù.';
            crOptimizeBtn.disabled = true;
            return;
        }

        crCartEmptyEl.style.display = 'block';
        crCartEmptyEl.textContent = 'Selected courses:';
        crOptimizeBtn.disabled = false;

        crCartCourseIds.forEach(id => {
            const course = crCurrentCourses.find(c => c.id === id) || {code: id, name: ''};
            const li = document.createElement('li');
            li.className = 'cr-cart-item';

            li.innerHTML = `
                <span><i class="fa-solid fa-circle-dot"></i> ${course.code || id} ${course.name ? '‚Äì ' + course.name : ''}</span>
                <button class="cr-btn-ghost" data-id="${id}">
                    <i class="fa-solid fa-xmark"></i> Remove
                </button>
            `;

            li.querySelector('button').addEventListener('click', () => crRemoveFromCart(id));
            crCartListEl.appendChild(li);
        });
    }

    function crAddToCart(courseId) {
        if (!crCartCourseIds.includes(courseId)) {
            crCartCourseIds.push(courseId);
            crRenderCart();
            crRenderCourses();
        }
    }

    function crRemoveFromCart(courseId) {
        crCartCourseIds = crCartCourseIds.filter(id => id !== courseId);
        crRenderCart();
        crRenderCourses();
    }

    // =============== SEARCH COURSES (CALL BACKEND) ===============
    async function crSearchCourses() {
        const q = crSearchInput.value.trim();
        const url = q ? `/course-registration/api/courses?q=${encodeURIComponent(q)}` : '/course-registration/api/courses';

        try {
            const res = await fetch(url);
            crCurrentCourses = await res.json();
        } catch (err) {
            console.error(err);
            crCurrentCourses = [];
        }

        crRenderCourses();
        crRenderCart();
    }

    crSearchBtn.addEventListener('click', crSearchCourses);
    crSearchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') crSearchCourses();
    });

    // =============== WEEKLY CALENDAR VIEW ===============
    function crRenderCalendar(schedule) {
        crCalendarGridEl.innerHTML = '';

        if (!schedule || schedule.length === 0) {
            crCalendarGridEl.innerHTML = '<p class="cr-muted cr-calendar-empty">No timetable yet. Run the optimizer first.</p>';
            return;
        }

        // Debug: Log all schedule items to verify all events are included
        console.log('Rendering calendar with', schedule.length, 'events:', schedule);

        const days = ['SUN', 'MON', 'TUES', 'WED', 'THURS'];
        const dayLabels = {
            'SUN': 'Sun',
            'SUNDAY': 'Sun',
            'MON': 'Mon',
            'MONDAY': 'Mon',
            'TUES': 'Tue',
            'TUESDAY': 'Tue',
            'WED': 'Wed',
            'WEDNESDAY': 'Wed',
            'THURS': 'Thu',
            'THURSDAY': 'Thu'
        };

        const startHourBase = 8;
        const endHourBase   = 16;  // Changed from 20 to 16 (8 AM to 4 PM)

        // day headers
        days.forEach((day, idx) => {
            const header = document.createElement('div');
            header.className = 'cr-day-header';
            header.style.gridColumn = (idx + 2).toString();
            header.style.gridRow = '1';
            header.textContent = dayLabels[day] || day;
            crCalendarGridEl.appendChild(header);
        });

        // time labels
        for (let hour = startHourBase; hour <= endHourBase; hour++) {
            const rowIndex = (hour - startHourBase) + 2;
            const timeLabel = document.createElement('div');
            timeLabel.className = 'cr-time-label';
            timeLabel.style.gridColumn = '1';
            timeLabel.style.gridRow = rowIndex.toString();
            timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
            crCalendarGridEl.appendChild(timeLabel);
        }

        function getDayIndex(dayStr) {
            const upper = String(dayStr || '').toUpperCase().trim();
            const map = {
                'SUN': 0,
                'SUNDAY': 0,
                'MON': 1,
                'MONDAY': 1,
                'TUES': 2,
                'TUESDAY': 2,
                'TUE': 2,
                'WED': 3,
                'WEDNESDAY': 3,
                'THURS': 4,
                'THURSDAY': 4,
                'THUR': 4,  // Handle abbreviated form
                'THU': 4
            };
            const index = map[upper] ?? -1;
            if (index < 0) {
                console.warn('Unknown day:', dayStr, 'mapped to index:', index);
            }
            return index;
        }

        // Group events by day and time to handle overlaps
        const eventsByDay = {};
        schedule.forEach(slot => {
            const dayIndex = getDayIndex(slot.day);
            if (dayIndex < 0) {
                console.warn('Skipping event with invalid day:', slot);
                return;
            }
            
            if (!eventsByDay[dayIndex]) {
                eventsByDay[dayIndex] = [];
            }
            eventsByDay[dayIndex].push(slot);
        });

        // Render events for each day
        Object.keys(eventsByDay).forEach(dayIndex => {
            const dayEvents = eventsByDay[dayIndex];
            const dayNum = parseInt(dayIndex);
            
            // Sort events by start time
            dayEvents.sort((a, b) => {
                const [ah, am = 0] = a.start.split(':').map(Number);
                const [bh, bm = 0] = b.start.split(':').map(Number);
                return (ah * 60 + am) - (bh * 60 + bm);
            });

            dayEvents.forEach((slot, eventIndex) => {
                // Parse start and end times (HH:MM format)
                const [sh, sm = 0] = slot.start.split(':').map(Number);
                const [eh, em = 0] = slot.end.split(':').map(Number);
                
                // Calculate which hour row to start and end on
                // Row 1 = headers, Row 2 = 8:00, Row 3 = 9:00, etc.
                const startRow = Math.max(2, (sh - startHourBase) + 2);
                // Calculate end row based on end hour (round up if minutes > 0)
                let endRow = (eh - startHourBase) + 2;
                if (em > 0) endRow += 1; // If end time has minutes, extend to next hour
                
                // Cap at maximum row (16:00 = row 10)
                const maxRow = (endHourBase - startHourBase) + 2;
                endRow = Math.min(maxRow + 1, endRow);
                
                // Calculate row span
                const rowSpan = Math.max(1, endRow - startRow);

                const event = document.createElement('div');
                event.className = 'cr-calendar-event ' + (slot.type === 'lecture' ? 'cr-lecture' : 'cr-lab');
                event.setAttribute('data-course', slot.course_code);
                event.setAttribute('data-day', slot.day);
                event.setAttribute('data-time', `${slot.start}-${slot.end}`);

                event.style.gridColumn = (dayNum + 2).toString();
                event.style.gridRow = `${startRow} / span ${rowSpan}`;

                const typeLabel = slot.type === 'lecture' ? 'Lec' : 'Lab/Tut';
                const typeIcon = slot.type === 'lecture' 
                    ? '<i class="fa-solid fa-chalkboard-teacher"></i>' 
                    : '<i class="fa-solid fa-flask"></i>';

                event.innerHTML = `
                    <div class="cr-event-header">
                        <span class="cr-event-icon">${typeIcon}</span>
                        <div class="cr-event-title">${slot.course_code}</div>
                    </div>
                    <div class="cr-event-sub">${typeLabel} ¬∑ ${slot.sub_type} ¬∑ Sec ${slot.section}</div>
                    <div class="cr-event-time">${slot.start}‚Äì${slot.end}</div>
                `;

                crCalendarGridEl.appendChild(event);
                console.log('Rendered event:', slot.course_code, slot.day, slot.start, '-', slot.end, 'at row', startRow, 'span', rowSpan);
            });
        });
        
        console.log('Total events rendered:', crCalendarGridEl.querySelectorAll('.cr-calendar-event').length, 'out of', schedule.length);
    }

    // =============== RUN OPTIMIZER (CALL BACKEND) ===============
    async function crRunOptimization() {
        crOptimizeStatusEl.textContent = 'Running optimizer...';
        crScheduleTableBody.innerHTML = '';
        crRenderCalendar([]);

        try {
            const res = await fetch('/course-registration/api/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ course_ids: crCartCourseIds })
            });

            const data = await res.json();

            if (data.status === 'ok') {
                crOptimizeStatusEl.textContent = '‚úÖ Conflict-free schedule found.';
                crScheduleTableBody.innerHTML = '';
                crCurrentSchedule = data.schedule;  // Store schedule for enrollment

                data.schedule.forEach(slot => {
                    const tr = document.createElement('tr');
                    tr.classList.add('cr-row-fade-in');
                    tr.innerHTML = `
                        <td>${slot.course_code} ‚Äì ${slot.course_name}</td>
                        <td>${slot.type}</td>
                        <td>${slot.sub_type}</td>
                        <td>${slot.section}</td>
                        <td>${slot.day}</td>
                        <td>${slot.start}</td>
                        <td>${slot.end}</td>
                    `;
                    crScheduleTableBody.appendChild(tr);
                });

                crRenderCalendar(data.schedule);
                crEnrollBtn.style.display = 'block';  // Show enroll button
            } else if (data.status === 'no_solution') {
                crOptimizeStatusEl.textContent = '‚ùå ' + (data.message || 'No conflict-free schedule found.');
                crEnrollBtn.style.display = 'none';
            } else {
                crOptimizeStatusEl.textContent = '‚ö† ' + (data.message || 'Unknown error from optimizer.');
                crEnrollBtn.style.display = 'none';
            }
        } catch (err) {
            console.error(err);
            crOptimizeStatusEl.textContent = '‚ö† Error calling optimizer.';
        }
    }

    crOptimizeBtn.addEventListener('click', crRunOptimization);

    // =============== ENROLL IN COURSES ===============
    async function crEnrollInCourses() {
        if (!crCurrentSchedule || crCurrentSchedule.length === 0) {
            crOptimizeStatusEl.textContent = '‚ö† No schedule to enroll. Run optimizer first.';
            return;
        }

        crEnrollBtn.disabled = true;
        crOptimizeStatusEl.textContent = 'Enrolling in courses...';

        try {
            const res = await fetch('/course-registration/api/enroll', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ schedule: crCurrentSchedule })
            });

            const data = await res.json();

            if (data.status === 'success' || data.status === 'partial') {
                crOptimizeStatusEl.textContent = `‚úÖ ${data.message || 'Successfully enrolled!'}`;
                if (data.errors && data.errors.length > 0) {
                    crOptimizeStatusEl.textContent += ' Errors: ' + data.errors.join(', ');
                }
                // Reload enrolled schedule from database
                await crLoadEnrolledSchedule();
            } else {
                crOptimizeStatusEl.textContent = '‚ö† ' + (data.error || 'Failed to enroll in courses.');
            }
        } catch (err) {
            console.error(err);
            crOptimizeStatusEl.textContent = '‚ö† Error enrolling in courses.';
        } finally {
            crEnrollBtn.disabled = false;
        }
    }

    crEnrollBtn.addEventListener('click', crEnrollInCourses);

    // =============== LOAD ENROLLED SCHEDULE FROM DATABASE ===============
    async function crLoadEnrolledSchedule() {
        try {
            const res = await fetch('/course-registration/api/my-schedule');
            const data = await res.json();

            if (data.status === 'ok' && data.schedule && data.schedule.length > 0) {
                // Update table
                crScheduleTableBody.innerHTML = '';
                data.schedule.forEach(slot => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${slot.course_code} ‚Äì ${slot.course_name}</td>
                        <td>${slot.type}</td>
                        <td>${slot.sub_type}</td>
                        <td>${slot.section}</td>
                        <td>${slot.day}</td>
                        <td>${slot.start}</td>
                        <td>${slot.end}</td>
                    `;
                    crScheduleTableBody.appendChild(tr);
                });

                // Update calendar
                crRenderCalendar(data.schedule);
                crOptimizeStatusEl.textContent = 'üìÖ Showing enrolled courses from database.';
            } else {
                // No enrolled courses yet
                crScheduleTableBody.innerHTML = '<tr><td colspan="7" class="cr-muted">No enrolled courses yet. Run optimizer and enroll.</td></tr>';
                crRenderCalendar([]);
            }
        } catch (err) {
            console.error('Error loading enrolled schedule:', err);
        }
    }

    // Initial load (fills list with all courses and enrolled schedule)
    crSearchCourses();
    crLoadEnrolledSchedule();

    // Logout handler
    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', { method: 'POST' });
            if (response.ok) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Logout error:', error);
            window.location.href = '/login';
        }
    }
</script>
</body>
</html>
