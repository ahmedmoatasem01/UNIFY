<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calendar with Tasks ‚Äî UNIFY</title>
    <script src="https://apis.google.com/js/client.js"></script>
    <link rel="stylesheet" href="../static/styles/Calendar.css">
    
</head>
<body>
  <div class="spinner" id="spinner" aria-hidden="true" title="Loading"></div>

  <div class="container" role="application" aria-labelledby="monthYear">
      <div class="header">
          <div style="display:flex;flex-direction:column;">
            <h1 id="monthYear" style="margin-bottom:6px;">December 2025</h1>
            <div style="font-size:13px;color:#666;">Monthly view ‚Äî click a day to see details</div>
          </div>

          <div class="controls" role="toolbar" aria-label="Calendar controls">
              <button class="btn btn-ghost" onclick="previousMonth()" aria-label="Previous month">‚Üê</button>
              <button class="btn btn-ghost" onclick="todayMonth()" aria-label="Current month">Today</button>
              <button class="btn btn-ghost" onclick="nextMonth()" aria-label="Next month">‚Üí</button>
              <button id="refreshBtn" class="btn btn-primary" onclick="refreshAll()" aria-label="Refresh calendar">Refresh</button>
              <button id="authBtn" class="auth-btn" onclick="handleAuthClick()" aria-label="Google sign in">Sign in with Google</button>
          </div>
      </div>

      <div id="status" class="status" aria-live="polite" style="min-height:36px;"></div>

      <div class="calendar-wrapper">
          <div>
              <div class="calendar" id="calendarGrid" role="grid" aria-label="Month calendar"></div>
          </div>

          <aside class="sidebar" aria-labelledby="upcomingTitle">
              <div class="day-details" id="dayDetails">
                <h4 id="dayDetailsTitle">Select a day</h4>
                <div id="dayDetailsContent" class="no-data">Click any day cell to view events and tasks for that date.</div>
              </div>

              <div class="sidebar" aria-label="Upcoming">
                <h3 id="upcomingTitle">Upcoming Events & Tasks</h3>
                <ul class="upcoming-list" id="upcomingList" style="padding-left:0;">
                    <li class="upcoming-item">Loading...</li>
                </ul>
              </div>
          </aside>
      </div>
  </div>

  <script>
    // Configuration
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    const Student_ID = '201234567';
    const API_KEY = 'bdd46e3d8127abc7d1746d89da3122ee5743396f5ebd15e389791c2234f28964';

    let currentDate = new Date();
    let calendarEvents = {};
    let tasksData = {};
    let selectedDateKey = null;

    // Initialize
    window.addEventListener('load', () => {
        gapi.load('client:auth2', initClient);
        loadTasksFromReminder();
        renderCalendar();
    });

    // small helpers
    function showLoading(flag){
      const s = document.getElementById('spinner');
      if (!s) return;
      s.classList.toggle('show', !!flag);
      const buttons = document.querySelectorAll('.controls button');
      buttons.forEach(b => b.disabled = !!flag);
    }

    // Refresh both sources
    function refreshAll(){
      showLoading(true);
      Promise.allSettled([loadCalendarEvents(), loadTasksFromReminder()]).finally(()=> {
        showLoading(false);
        showStatus('Refreshed', 'success');
      });
    }

    // Initialize Google API Client
    function initClient() {
        gapi.client.init({
            apiKey: API_KEY,
            studentId: Student_ID,
            scope: SCOPES,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
        }).then(() => {
            const authBtn = document.getElementById('authBtn');
            try {
              const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
              authBtn.textContent = isSignedIn ? 'Sign out' : 'Sign in';
              if (isSignedIn) loadCalendarEvents();
            } catch(e){
              // older or unauthenticated gapi state
              authBtn.textContent = 'Sign in';
            }
        }).catch(err=>{
          console.warn('gapi init failed', err);
        });
    }

    // Handle Authentication
    function handleAuthClick() {
        try {
          const authInstance = gapi.auth2.getAuthInstance();
          const isSignedIn = authInstance.isSignedIn.get();
          if (isSignedIn) {
              authInstance.signOut().then(() => {
                  document.getElementById('authBtn').textContent = 'Sign in';
                  calendarEvents = {};
                  renderCalendar();
                  showStatus('Signed out', 'success');
              });
          } else {
              authInstance.signIn().then(() => {
                  document.getElementById('authBtn').textContent = 'Sign out';
                  loadCalendarEvents();
                  showStatus('Signed in', 'success');
              });
          }
        } catch(e){
          // If gapi auth not initialized, notify user
          showStatus('Google API auth not available in this environment', 'error');
          console.warn(e);
        }
    }

    // Load Google Calendar Events
    async function loadCalendarEvents() {
        showLoading(true);
        try {
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            const resp = await gapi.client.calendar.events.list({
                calendarId: 'primary',
                timeMin: startOfMonth.toISOString(),
                timeMax: endOfMonth.toISOString(),
                showDeleted: false,
                singleEvents: true,
                orderBy: 'startTime',
            });
            calendarEvents = {};
            const events = resp.result.items || [];

            events.forEach(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                const dateKey = formatDateKey(eventDate);

                if (!calendarEvents[dateKey]) calendarEvents[dateKey] = [];

                calendarEvents[dateKey].push({
                    title: event.summary || 'No title',
                    time: event.start.dateTime ? eventDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'All Day',
                    type: 'calendar',
                    raw: event
                });
            });

            renderCalendar();
            updateUpcomingList();
            showStatus(`Loaded ${events.length} calendar events`, 'success');
            return resp;
        } catch (error) {
            showStatus('Error loading calendar: ' + (error.message || error), 'error');
            console.warn(error);
            throw error;
        } finally {
            showLoading(false);
        }
    }

    // Load Tasks from Reminder
    async function loadTasksFromReminder() {
        showLoading(true);
        try {
            const resp = await fetch('/api/reminders');
            if (!resp.ok) throw new Error('Failed to load reminders');
            const tasks = await resp.json();

            tasksData = {};
            tasks.forEach(task => {
                const taskDate = new Date(task.dueDate);
                const dateKey = formatDateKey(taskDate);

                if (!tasksData[dateKey]) tasksData[dateKey] = [];

                tasksData[dateKey].push({
                    title: task.title,
                    time: new Date(task.dueDate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    type: 'task',
                    priority: task.priority,
                    status: (task.status || 'pending').toLowerCase(),
                    raw: task
                });
            });

            renderCalendar();
            updateUpcomingList();
            return tasks;
        } catch (err){
            console.warn('reminder load failed:', err);
            loadMockTasks();
            return null;
        } finally {
            showLoading(false);
        }
    }

    // Mock Tasks for Demo
    function loadMockTasks() {
        const today = new Date();
        const statuses = ['pending', 'inprogress', 'completed'];
        tasksData = {};

        for (let i = 0; i < 8; i++) {
            const taskDate = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
            const dateKey = formatDateKey(taskDate);

            if (!tasksData[dateKey]) tasksData[dateKey] = [];

            tasksData[dateKey].push({
                title: `Task ${i + 1}`,
                time: `${9 + (i % 8)}:00`,
                type: 'task',
                status: statuses[i % statuses.length]
            });
        }

        renderCalendar();
        updateUpcomingList();
    }

    // Format date key (YYYY-MM-DD)
    function formatDateKey(date) {
        return date.toISOString().split('T')[0];
    }

    function capitalize(s){ if(!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1); }

    // Render Calendar
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('monthYear').textContent =
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = day;
            grid.appendChild(header);
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        for (let i = firstDay - 1; i >= 0; i--) {
            const cell = createDayCell(daysInPrevMonth - i, true, new Date(year, month - 1, daysInPrevMonth - i));
            grid.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = createDayCell(day, false, new Date(year, month, day));
            grid.appendChild(cell);
        }

        const totalCells = grid.children.length - 7;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
            const cell = createDayCell(day, true, new Date(year, month + 1, day));
            grid.appendChild(cell);
        }

        // if selectedDate is in current view, re-select it visually
        if (selectedDateKey) {
          const el = document.querySelector(`.day-cell[data-date="${selectedDateKey}"]`);
          if (el) el.classList.add('selected');
        }
    }

    // Create Day Cell (shows task status)
    function createDayCell(day, isOtherMonth, date) {
        const cell = document.createElement('div');
        const dateKey = formatDateKey(date);
        const today = formatDateKey(new Date());

        cell.className = 'day-cell';
        if (isOtherMonth) cell.classList.add('other-month');
        if (dateKey === today) cell.classList.add('today');

        cell.setAttribute('role','gridcell');
        cell.setAttribute('aria-label', date.toDateString());
        cell.dataset.date = dateKey;
        cell.tabIndex = 0;

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        const eventsDiv = document.createElement('div');
        eventsDiv.className = 'day-events';

        // Add calendar events
        if (calendarEvents[dateKey]) {
            calendarEvents[dateKey].forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'event calendar';
                eventEl.textContent = `üìÖ ${event.title}`;
                eventEl.title = `${event.time}`;
                eventsDiv.appendChild(eventEl);
            });
        }

        // Add tasks (include status badge)
        if (tasksData[dateKey]) {
            tasksData[dateKey].forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'event task';
                const status = (task.status || 'pending').toLowerCase();
                taskEl.innerHTML = `‚úì ${escapeHtml(task.title)} <span class="task-status status-${status}">${capitalize(status)}</span>`;
                taskEl.title = `${task.time} ‚Ä¢ ${capitalize(status)}`;
                eventsDiv.appendChild(taskEl);
            });
        }

        cell.appendChild(eventsDiv);

        // selection handlers
        cell.addEventListener('click', () => selectDay(dateKey));
        cell.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectDay(dateKey); } });

        return cell;
    }

    // select a day and render details
    function selectDay(dateKey) {
      selectedDateKey = dateKey;
      document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
      const el = document.querySelector(`.day-cell[data-date="${dateKey}"]`);
      if (el) el.classList.add('selected');
      renderDayDetails(dateKey);
    }

    function renderDayDetails(dateKey) {
      const title = document.getElementById('dayDetailsTitle');
      const content = document.getElementById('dayDetailsContent');
      title.textContent = `Details ‚Äî ${dateKey}`;
      const items = [];
      if (calendarEvents[dateKey]) {
        calendarEvents[dateKey].forEach(ev => items.push(Object.assign({kind:'calendar'}, ev)));
      }
      if (tasksData[dateKey]) {
        tasksData[dateKey].forEach(t => items.push(Object.assign({kind:'task'}, t)));
      }
      items.sort((a,b) => (a.time||'') > (b.time||'') ? 1 : -1);

      if (!items.length) {
        content.className = 'no-data';
        content.innerHTML = 'No events or tasks for this day.';
        return;
      }

      content.className = '';
      content.innerHTML = items.map(it => {
        if (it.kind === 'task') {
          const status = (it.status||'pending').toLowerCase();
          return `<div class="detail-item">
                    <div style="min-width:0">
                      <div style="font-weight:600">${escapeHtml(it.title)}</div>
                      <div style="font-size:12px;color:#666">${it.time || ''} ‚Ä¢ priority: ${escapeHtml(it.priority||'normal')}</div>
                    </div>
                    <div style="text-align:right">
                      <div class="task-status status-${status}" style="display:inline-block;padding:4px 8px;border-radius:10px;">${capitalize(status)}</div>
                    </div>
                  </div>`;
        } else {
          return `<div class="detail-item">
                    <div style="min-width:0">
                      <div style="font-weight:600">${escapeHtml(it.title)}</div>
                      <div style="font-size:12px;color:#666">${it.time || 'All Day'}</div>
                    </div>
                    <div style="text-align:right">üìÖ</div>
                  </div>`;
        }
      }).join('');
    }

    // Update Upcoming List (shows status)
    function updateUpcomingList() {
        const upcomingList = document.getElementById('upcomingList');
        const upcoming = [];

        for (let i = 0; i < 14; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            const dateKey = formatDateKey(date);

            if (calendarEvents[dateKey]) {
                calendarEvents[dateKey].forEach(event => {
                    upcoming.push({ title: event.title, date: dateKey, time: event.time, type: 'calendar' });
                });
            }

            if (tasksData[dateKey]) {
                tasksData[dateKey].forEach(task => {
                    upcoming.push({ title: task.title, date: dateKey, time: task.time, type: 'task', status: task.status || 'pending' });
                });
            }
        }

        upcoming.sort((a,b) => new Date(a.date) - new Date(b.date));

        if (upcoming.length === 0) {
            upcomingList.innerHTML = '<li class="upcoming-item">No upcoming events</li>';
        } else {
            upcomingList.innerHTML = upcoming.map(item => {
                if (item.type === 'task') {
                    const status = (item.status || 'pending').toLowerCase();
                    return `<li class="upcoming-item task">
                              <strong>‚úì ${escapeHtml(item.title)}</strong>
                              <div class="upcoming-time">${item.date} at ${item.time} <span class="task-status status-${status}">${capitalize(status)}</span></div>
                            </li>`;
                } else {
                    return `<li class="upcoming-item calendar">
                              <strong>üìÖ ${escapeHtml(item.title)}</strong>
                              <div class="upcoming-time">${item.date} at ${item.time}</div>
                            </li>`;
                }
            }).join('');
        }
    }

    // Navigation
    function previousMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
    function todayMonth() { currentDate = new Date(); renderCalendar(); }

    // Show Status Message
    function showStatus(message, type) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status ${type || ''}`;
        setTimeout(()=> { status.textContent = ''; status.className = 'status'; }, 3500);
    }

    // simple html escaper for titles
    function escapeHtml(text) {
        return (text || '').replace(/[&<>"'`=\/]/g, function (s) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' })[s];
        });
    }
  </script>
</body>
</html>