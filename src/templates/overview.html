<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unify | Overview</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/course_registration.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/overview.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="cr-body">
<div class="cr-app-layout">
    <aside class="cr-sidebar">
        <div class="cr-sidebar-header">
            <div class="cr-brand-logo">U</div>
            <div>
                <h2 class="cr-brand-title">Unify</h2>
                <p class="cr-brand-subtitle">Student Assistant</p>
            </div>
        </div>
        {% set active_page = 'overview' %}
        {% include 'components/sidebar_nav.html' %}
        <div class="cr-sidebar-footer">
            <button class="cr-btn-ghost cr-logout-btn" onclick="handleLogout()">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span>Log out</span>
            </button>
            <p class="cr-small-text">CSAI 203 Â· Team 27</p>
        </div>
    </aside>

    <main class="cr-main-panel">
        <!-- Topbar -->
        <header class="cr-topbar">
            <div class="cr-topbar-left">
                <h1><i class="fa-solid fa-chart-column"></i> Overview</h1>
                <p>Welcome back, {{ user_data.name if user_data else 'Student' }}!</p>
            </div>
            {% include 'components/topbar_right.html' %}
        </header>

        <div class="overview-wrapper">
            <!-- Left Column: Statistics & Notifications -->
            <div class="left-column">
                <!-- Notifications Card -->
                <div class="card notifications-card">
                    <div class="card-header">
                        <h2><i class="fas fa-bell"></i> Notifications</h2>
                        <span class="notification-badge">
                            {% if notifications %}
                                {{ notifications|selectattr('read', 'equalto', False)|list|length }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        {% if notifications %}
                        <div class="notifications-list">
                            {% for notification in notifications[:5] %}
                            <div class="notification-item {% if not notification.get('read') %}unread{% endif %} priority-{{ notification.get('priority', 'normal') }}">
                                <div class="notification-icon">
                                    {% if notification.get('type') == 'assignment' %}
                                        <i class="fas fa-file-alt"></i>
                                    {% elif notification.get('type') == 'grade' %}
                                        <i class="fas fa-graduation-cap"></i>
                                    {% elif notification.get('type') == 'exam' %}
                                        <i class="fas fa-clipboard-check"></i>
                                    {% else %}
                                        <i class="fas fa-bullhorn"></i>
                                    {% endif %}
                                </div>
                                <div class="notification-content">
                                    <h4>{{ notification.get('title', notification.get('subject', 'Notification')) }}</h4>
                                    <p>{{ notification.get('message', notification.get('content', '')) }}</p>
                                    <span class="notification-time">{{ notification.get('time', notification.get('sent_date', 'Now')) }}</span>
                                </div>
                                {% if not notification.get('read') %}
                                <div class="notification-dot"></div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <a href="/notifications/" class="view-all-link">View all notifications <i class="fas fa-arrow-right"></i></a>
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <p>No new notifications</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_courses if stats else 0 }}</h3>
                            <p>Active Courses</p>
                            <span class="stat-change positive">+2 this semester</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.active_tasks if stats else 0 }}</h3>
                            <p>Active Tasks</p>
                            <span class="stat-change">3 due today</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.upcoming_events if stats else 0 }}</h3>
                            <p>Upcoming Events</p>
                            <span class="stat-change">2 this week</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.completed_assignments if stats else 0 }}</h3>
                            <p>Completed Assignments</p>
                            <span class="stat-change positive">+5 this month</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="card schedule-card">
                    <div class="card-header">
                        <h2><i class="fas fa-calendar-day"></i> Today's Schedule</h2>
                        <span class="date-badge">Today</span>
                    </div>
                    <div class="card-body">
                        {% if today_schedule %}
                        <div class="schedule-list">
                            {% for item in today_schedule %}
                            <div class="schedule-item">
                                <div class="schedule-time">
                                    <span class="time">{{ item.get('time', '10:00 AM') }}</span>
                                </div>
                                <div class="schedule-details">
                                    <h4>{{ item.get('course_name', 'Course') }}</h4>
                                    <p><i class="fas fa-chalkboard-teacher"></i> {{ item.get('instructor', 'Instructor') }}</p>
                                    <p><i class="fas fa-map-marker-alt"></i> {{ item.get('location', 'Room 101') }}</p>
                                    <span class="schedule-type type-{{ item.get('type', 'lecture').lower() }}">{{ item.get('type', 'Lecture')|title }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>No classes scheduled for today</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions">
                            <a href="/course-registration" class="action-btn">
                                <i class="fas fa-plus-circle"></i>
                                <span>Add Course</span>
                            </a>
                            <a href="/api/advisor/chat" class="action-btn">
                                <i class="fas fa-user-graduate"></i>
                                <span>Academic Advisor</span>
                            </a>
                            <a href="/notes" class="action-btn">
                                <i class="fas fa-sticky-note"></i>
                                <span>Create Note</span>
                            </a>
                            <a href="/ai-assistant/" class="action-btn">
                                <i class="fas fa-robot"></i>
                                <span>AI Assistant</span>
                            </a>
                            <a href="/tasks" class="action-btn">
                                <i class="fas fa-tasks"></i>
                                <span>New Task</span>
                            </a>
                            <a href="/course-registration" class="action-btn">
                                <i class="fas fa-book"></i>
                                <span>View Courses</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Academic Dashboard Card - Only for Students, After Schedule and Quick Actions -->
                {% if user_data.is_student %}
                <div class="card academic-dashboard-card" id="academicDashboard">
                    <div class="card-header">
                        <h2><i class="fas fa-graduation-cap"></i> Academic Dashboard</h2>
                    </div>
                    <div class="card-body">
                        <div id="dashboardLoading" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--cr-accent);"></i>
                            <p style="margin-top: 16px; color: var(--cr-text-muted);">Loading academic data...</p>
                        </div>
                        <div id="dashboardContent" style="display: none;">
                            <!-- GPA Section -->
                            <div class="dashboard-section">
                                <h3 style="margin: 0 0 16px 0; color: var(--cr-text); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-chart-line"></i> GPA Overview
                                </h3>
                                <div class="gpa-display">
                                    <div class="gpa-main">
                                        <div class="gpa-value" id="cumulativeGPA">0.00</div>
                                        <div class="gpa-label">Cumulative GPA</div>
                                    </div>
                                    <div class="gpa-details">
                                        <div class="gpa-stat">
                                            <span class="stat-label">Credits Completed</span>
                                            <span class="stat-value" id="totalCredits">0</span>
                                        </div>
                                        <div class="gpa-stat">
                                            <span class="stat-label">Courses Completed</span>
                                            <span class="stat-value" id="coursesCompleted">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cohort Comparison Section -->
                            <div class="dashboard-section" style="margin-top: 24px;">
                                <h3 style="margin: 0 0 16px 0; color: var(--cr-text); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-users"></i> Cohort Comparison
                                </h3>
                                <div class="cohort-comparison" id="cohortComparison">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Graduation Timeline Section -->
                            <div class="dashboard-section" style="margin-top: 24px;">
                                <h3 style="margin: 0 0 16px 0; color: var(--cr-text); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-calendar-alt"></i> Graduation Timeline
                                </h3>
                                <div class="graduation-timeline" id="graduationTimeline">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Course Grades Section -->
                            <div class="dashboard-section" style="margin-top: 24px;">
                                <h3 style="margin: 0 0 16px 0; color: var(--cr-text); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-book"></i> Recent Course Grades
                                </h3>
                                <div class="course-grades-list" id="courseGradesList">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

<script src="{{ url_for('static', filename='scripts/theme-toggle.js') }}"></script>
<script src="{{ url_for('static', filename='scripts/notifications.js') }}"></script>
<script>
async function handleLogout() {
    try {
        const response = await fetch('/auth/logout', { method: 'POST' });
        if (response.ok) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login';
    }
}

// Load Academic Dashboard Data (Only for Students)
async function loadAcademicDashboard() {
    // Check if user is a student and dashboard element exists
    const dashboardElement = document.getElementById('academicDashboard');
    if (!dashboardElement) {
        console.log('Academic Dashboard: Not available for this user (instructor/TA)');
        return; // Dashboard not available for this user (instructor/TA)
    }
    
    console.log('Academic Dashboard: Loading data...');
    
    try {
        const response = await fetch('/overview/api/academic-dashboard');
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({error: 'Unknown error'}));
            console.error('Academic Dashboard: API error', errorData);
            throw new Error(errorData.error || 'Failed to load dashboard data');
        }
        
        const data = await response.json();
        console.log('Academic Dashboard: Data loaded', data);
        
        // Hide loading, show content
        const loadingEl = document.getElementById('dashboardLoading');
        const contentEl = document.getElementById('dashboardContent');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (contentEl) contentEl.style.display = 'block';
        
        // Populate GPA
        if (data.gpa) {
            document.getElementById('cumulativeGPA').textContent = data.gpa.cumulative.toFixed(2);
            document.getElementById('totalCredits').textContent = data.gpa.total_credits || 0;
            document.getElementById('coursesCompleted').textContent = data.course_grades?.length || 0;
        }
        
        // Populate Cohort Comparison
        if (data.cohort_comparison) {
            const cohort = data.cohort_comparison;
            const comparisonColors = {
                'excellent': '#22c55e',
                'above_average': '#3b82f6',
                'average': '#f59e0b',
                'below_average': '#ef4444',
                'no_data': '#9ca3af',
                'insufficient_data': '#9ca3af'
            };
            const comparisonLabels = {
                'excellent': 'Excellent',
                'above_average': 'Above Average',
                'average': 'Average',
                'below_average': 'Below Average',
                'no_data': 'No Data',
                'insufficient_data': 'Insufficient Data'
            };
            
            const color = comparisonColors[cohort.comparison] || '#9ca3af';
            const label = comparisonLabels[cohort.comparison] || 'Unknown';
            
            document.getElementById('cohortComparison').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div style="background: var(--cr-bg-elevated); padding: 16px; border-radius: 8px; border-left: 4px solid ${color};">
                        <div style="font-size: 0.85rem; color: var(--cr-text-muted); margin-bottom: 4px;">Your GPA</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--cr-text);">${cohort.student_gpa.toFixed(2)}</div>
                    </div>
                    <div style="background: var(--cr-bg-elevated); padding: 16px; border-radius: 8px; border-left: 4px solid var(--cr-accent);">
                        <div style="font-size: 0.85rem; color: var(--cr-text-muted); margin-bottom: 4px;">Cohort Average</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--cr-text);">${cohort.cohort_avg_gpa.toFixed(2)}</div>
                    </div>
                </div>
                <div style="background: var(--cr-bg-elevated); padding: 16px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: var(--cr-text-muted); font-size: 0.9rem;">Rank in Cohort</span>
                        <span style="font-weight: 600; color: var(--cr-text);">#${cohort.student_rank} of ${cohort.cohort_size}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: var(--cr-text-muted); font-size: 0.9rem;">Percentile</span>
                        <span style="font-weight: 600; color: var(--cr-text);">${cohort.percentile}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--cr-text-muted); font-size: 0.9rem;">Status</span>
                        <span style="padding: 4px 12px; background: ${color}20; color: ${color}; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${label}</span>
                    </div>
                </div>
            `;
        }
        
        // Populate Graduation Timeline
        if (data.graduation_timeline) {
            const timeline = data.graduation_timeline;
            const onTrackColor = timeline.on_track ? '#22c55e' : '#f59e0b';
            const onTrackIcon = timeline.on_track ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            document.getElementById('graduationTimeline').innerHTML = `
                <div style="background: var(--cr-bg-elevated); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="color: var(--cr-text-muted); font-size: 0.9rem;">Predicted Graduation</span>
                        <span style="font-weight: 700; color: var(--cr-accent); font-size: 1.1rem;">${timeline.predicted_graduation || 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: var(--cr-text-muted); font-size: 0.9rem;">Credits Completed</span>
                        <span style="font-weight: 600; color: var(--cr-text);">${timeline.credits_completed} / ${timeline.credits_completed + timeline.credits_remaining}</span>
                    </div>
                    <div style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 0.85rem; color: var(--cr-text-muted);">Progress</span>
                            <span style="font-size: 0.85rem; font-weight: 600; color: var(--cr-text);">${timeline.progress_percentage}%</span>
                        </div>
                        <div style="height: 8px; background: var(--cr-bg); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${timeline.progress_percentage}%; background: linear-gradient(90deg, var(--cr-accent), var(--cr-accent-dark)); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                <div style="background: ${onTrackColor}20; padding: 12px; border-radius: 8px; border-left: 4px solid ${onTrackColor};">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas ${onTrackIcon}" style="color: ${onTrackColor};"></i>
                        <span style="color: var(--cr-text); font-weight: 500;">
                            ${timeline.on_track ? 'On track for graduation' : 'Slightly behind schedule'}
                        </span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.85rem; color: var(--cr-text-muted);">
                        ${timeline.semesters_remaining} semester(s) remaining
                    </div>
                </div>
            `;
        }
        
        // Populate Course Grades
        if (data.course_grades && data.course_grades.length > 0) {
            const gradesHtml = data.course_grades.slice(0, 5).map(course => {
                const gradeColor = course.grade_point >= 3.0 ? '#22c55e' : course.grade_point >= 2.0 ? '#f59e0b' : '#ef4444';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cr-bg-elevated); border-radius: 8px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--cr-text); margin-bottom: 4px;">${course.course_code}</div>
                            <div style="font-size: 0.85rem; color: var(--cr-text-muted);">${course.course_name}</div>
                            <div style="font-size: 0.75rem; color: var(--cr-text-muted); margin-top: 4px;">${course.semester || 'N/A'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: ${gradeColor};">${course.grade}</div>
                            <div style="font-size: 0.75rem; color: var(--cr-text-muted);">${course.credits} credits</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('courseGradesList').innerHTML = gradesHtml;
        } else {
            document.getElementById('courseGradesList').innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--cr-text-muted);">
                    <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.5; margin-bottom: 8px;"></i>
                    <p>No completed courses with grades yet</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading academic dashboard:', error);
        document.getElementById('dashboardLoading').innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--cr-text-muted);">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                <p>Failed to load academic dashboard data</p>
            </div>
        `;
    }
}

// Load dashboard on page load
document.addEventListener('DOMContentLoaded', loadAcademicDashboard);
</script>
</body>
</html>
