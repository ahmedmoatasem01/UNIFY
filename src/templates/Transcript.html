<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unify | Transcript</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/course_registration.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="cr-body">
<div class="cr-app-layout">
    <!-- Sidebar -->
    <aside class="cr-sidebar">
        <div class="cr-sidebar-header">
            <div class="cr-brand-logo">U</div>
            <div>
                <h2 class="cr-brand-title">Unify</h2>
                <p class="cr-brand-subtitle">Student Assistant</p>
            </div>
        </div>
        <nav class="cr-sidebar-nav">
            <a class="cr-nav-item" href="/overview">
                <i class="fa-solid fa-chart-column"></i>
                <span>Overview</span>
            </a>
            <a class="cr-nav-item" href="/schedule">
                <i class="fa-solid fa-calendar-day"></i>
                <span>Schedule</span>
            </a>
            <a class="cr-nav-item" href="/tasks">
                <i class="fa-solid fa-list-check"></i>
                <span>Tasks</span>
            </a>
            <a class="cr-nav-item" href="/notes">
                <i class="fa-solid fa-note-sticky"></i>
                <span>Notes &amp; Summaries</span>
            </a>
            <a class="cr-nav-item" href="/calendar">
                <i class="fa-solid fa-bell"></i>
                <span>Calendar &amp; Reminders</span>
            </a>
            <a class="cr-nav-item" href="/messages">
                <i class="fa-solid fa-message"></i>
                <span>Messages</span>
            </a>
            <a class="cr-nav-item active" href="/transcript">
                <i class="fa-solid fa-file-lines"></i>
                <span>Transcript</span>
            </a>
            <a class="cr-nav-item" href="/course-registration">
                <i class="fa-solid fa-book-open"></i>
                <span>Course Registration</span>
            </a>
            <a class="cr-nav-item" href="/settings">
                <i class="fa-solid fa-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
        <div class="cr-sidebar-footer">
            <button class="cr-btn-ghost cr-logout-btn" onclick="handleLogout()">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span>Log out</span>
            </button>
            <p class="cr-small-text">CSAI 203 · Team 5</p>
        </div>
    </aside>

    <!-- Main Panel -->
    <main class="cr-main-panel">
        {% include 'components/topbar.html' %}
        {% block topbar_title %}
        <div class="cr-topbar-left">
            <h1><i class="fa-solid fa-file-lines"></i> Transcript</h1>
            <p>View your academic transcript</p>
        </div>
        {% endblock %}
        <div class="cr-content" style="padding: 20px;">
            <p>Transcript content will be displayed here.</p>
        </div>
    </main>
</div>
<script src="{{ url_for('static', filename='scripts/theme-toggle.js') }}"></script>
<script>
    // Mock Transcript Data
    const transcriptData = {
        student: {
            name: 'Ahmed Hassan',
            id: '201234567',
            program: 'Computer Science',
            email: 'ahmed.hassan@student.example.com',
            avatar: 'A'
        },
        summary: {
            cumulativeGPA: 3.75,
            totalCredits: 120,
            academicStanding: 'Good',
            deansListCount: 6
        },
        semesters: [
            {
                id: 'fall-2021',
                name: 'Fall 2021',
                gpa: 3.8,
                credits: 15,
                courses: [
                    { code: 'CS101', name: 'Introduction to Programming', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'MATH201', name: 'Calculus I', credits: 4, grade: 'A', gradePoint: 4.0 },
                    { code: 'ENG101', name: 'English Composition', credits: 3, grade: 'B+', gradePoint: 3.3 },
                    { code: 'PHY101', name: 'Physics I', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CHM101', name: 'Chemistry I', credits: 3, grade: 'A-', gradePoint: 3.7 }
                ]
            },
            {
                id: 'spring-2022',
                name: 'Spring 2022',
                gpa: 3.7,
                credits: 16,
                courses: [
                    { code: 'CS102', name: 'Data Structures', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'MATH202', name: 'Calculus II', credits: 4, grade: 'A', gradePoint: 4.0 },
                    { code: 'PHYS102', name: 'Physics II', credits: 4, grade: 'A-', gradePoint: 3.7 },
                    { code: 'CS103', name: 'Discrete Mathematics', credits: 3, grade: 'B+', gradePoint: 3.3 },
                    { code: 'CS104', name: 'Digital Logic', credits: 2, grade: 'A', gradePoint: 4.0 }
                ]
            },
            {
                id: 'fall-2022',
                name: 'Fall 2022',
                gpa: 3.9,
                credits: 15,
                courses: [
                    { code: 'CS201', name: 'Algorithms', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS202', name: 'Database Systems', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS203', name: 'Web Development', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS204', name: 'Software Engineering', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'MATH301', name: 'Linear Algebra', credits: 3, grade: 'A-', gradePoint: 3.7 }
                ]
            },
            {
                id: 'spring-2023',
                name: 'Spring 2023',
                gpa: 3.75,
                credits: 15,
                courses: [
                    { code: 'CS205', name: 'Operating Systems', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS206', name: 'Computer Networks', credits: 3, grade: 'A-', gradePoint: 3.7 },
                    { code: 'CS207', name: 'Mobile Development', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS208', name: 'Cybersecurity', credits: 3, grade: 'B+', gradePoint: 3.3 },
                    { code: 'MATH302', name: 'Probability & Statistics', credits: 3, grade: 'A', gradePoint: 4.0 }
                ]
            },
            {
                id: 'fall-2023',
                name: 'Fall 2023',
                gpa: 3.8,
                credits: 15,
                courses: [
                    { code: 'CS301', name: 'AI & Machine Learning', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS302', name: 'Data Mining', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS303', name: 'Cloud Computing', credits: 3, grade: 'A-', gradePoint: 3.7 },
                    { code: 'CS304', name: 'Advanced Algorithms', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'TECH401', name: 'Capstone Project I', credits: 3, grade: 'A', gradePoint: 4.0 }
                ]
            },
            {
                id: 'spring-2024',
                name: 'Spring 2024',
                gpa: 3.7,
                credits: 15,
                courses: [
                    { code: 'CS305', name: 'Advanced AI', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'CS306', name: 'Deep Learning', credits: 3, grade: 'A-', gradePoint: 3.7 },
                    { code: 'CS307', name: 'Natural Language Processing', credits: 3, grade: 'A', gradePoint: 4.0 },
                    { code: 'TECH402', name: 'Capstone Project II', credits: 3, grade: 'B+', gradePoint: 3.3 },
                    { code: 'CS308', name: 'Advanced Cybersecurity', credits: 3, grade: 'A', gradePoint: 4.0 }
                ]
            }
        ]
    };

    // Grade to Point Conversion
    const gradePoints = {
        'A+': 4.0, 'A': 4.0, 'A-': 3.7,
        'B+': 3.3, 'B': 3.0, 'B-': 2.7,
        'C+': 2.3, 'C': 2.0, 'C-': 1.7,
        'D+': 1.3, 'D': 1.0, 'D-': 0.7,
        'F': 0.0
    };

    let filteredCourses = [];
    let allCourses = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        populateUserData();
        populateSummary();
        populateSemesters();
        populateAllCourses();
        renderTranscriptTable(allCourses);
        initializeGradeChart();
        populateHonors();
        setupEventListeners();
    });

    function populateUserData() {
        document.getElementById('userName').textContent = transcriptData.student.name;
        document.getElementById('userAvatar').textContent = transcriptData.student.avatar;
        document.getElementById('userRole').textContent = `${transcriptData.student.program} · ID: ${transcriptData.student.id}`;
    }

    function populateSummary() {
        document.getElementById('cumulativeGPA').textContent = transcriptData.summary.cumulativeGPA.toFixed(2);
        document.getElementById('totalCredits').textContent = transcriptData.summary.totalCredits;
        document.getElementById('semesterCount').textContent = transcriptData.semesters.length;
        document.getElementById('academicStanding').textContent = transcriptData.summary.academicStanding;
        document.getElementById('coursesCompleted').textContent = allCourses.length;
        document.getElementById('deansListCount').textContent = transcriptData.summary.deansListCount;
    }

    function populateAllCourses() {
        allCourses = [];
        transcriptData.semesters.forEach(semester => {
            semester.courses.forEach(course => {
                allCourses.push({
                    ...course,
                    semester: semester.name,
                    semesterId: semester.id
                });
            });
        });
    }

    function populateSemesters() {
        const container = document.getElementById('semesterTabs');
        const filterSelect = document.getElementById('semesterFilter');

        transcriptData.semesters.forEach((semester, idx) => {
            const btn = document.createElement('button');
            btn.className = 'ts-semester-btn' + (idx === 0 ? ' active' : '');
            btn.textContent = semester.name;
            btn.onclick = () => selectSemester(semester.id);
            container.appendChild(btn);

            const option = document.createElement('option');
            option.value = semester.id;
            option.textContent = semester.name;
            filterSelect.appendChild(option);
        });

        selectSemester(transcriptData.semesters[0].id);
    }

    function selectSemester(semesterId) {
        document.querySelectorAll('.ts-semester-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const semester = transcriptData.semesters.find(s => s.id === semesterId);
        const container = document.getElementById('coursesContainer');
        container.innerHTML = `
            <div class="ts-semester-summary">
                <div class="ts-semester-stat">
                    <p>Semester GPA</p>
                    <p class="ts-semester-gpa">${semester.gpa.toFixed(2)}</p>
                </div>
                <div class="ts-semester-stat">
                    <p>Credits Taken</p>
                    <p class="ts-semester-gpa">${semester.credits}</p>
                </div>
            </div>
            <div class="ts-semester-courses">
                ${semester.courses.map(course => `
                    <div class="ts-course-card">
                        <div class="ts-course-header">
                            <h4>${course.code}</h4>
                            <span class="ts-grade-badge ts-grade-${course.grade.replace(/[^A-Z]/g, '')}">${course.grade}</span>
                        </div>
                        <p class="ts-course-name">${course.name}</p>
                        <div class="ts-course-footer">
                            <span><i class="fa-solid fa-book"></i> ${course.credits} Credits</span>
                            <span><i class="fa-solid fa-star"></i> ${course.gradePoint.toFixed(1)} QP</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function populateHonors() {
        const honors = [];
        const deansListSemesters = transcriptData.semesters.filter(s => s.gpa >= 3.7);
        
        if (deansListSemesters.length > 0) {
            honors.push(`Dean's List: ${deansListSemesters.length} semester${deansListSemesters.length > 1 ? 's' : ''}`);
        }
        if (transcriptData.summary.cumulativeGPA >= 3.9) {
            honors.push('High Honors (3.9+ GPA)');
        }
        if (transcriptData.summary.cumulativeGPA >= 3.7) {
            honors.push('Honors (3.7+ GPA)');
        }

        const honorsList = document.getElementById('honorsList');
        if (honors.length > 0) {
            document.getElementById('honorsSection').style.display = 'block';
            honorsList.innerHTML = honors.map(h => `
                <div class="ts-honor-item">
                    <i class="fa-solid fa-award"></i>
                    <span>${h}</span>
                </div>
            `).join('');
        }
    }

    function renderTranscriptTable(courses) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = courses.map(course => `
            <tr>
                <td>${course.code}</td>
                <td>${course.name}</td>
                <td>${course.credits}</td>
                <td><span class="ts-grade-badge ts-grade-${course.grade.replace(/[^A-Z]/g, '')}">${course.grade}</span></td>
                <td>${(course.gradePoint * course.credits).toFixed(1)}</td>
                <td>${course.semester}</td>
            </tr>
        `).join('');
        filteredCourses = courses;
    }

    function initializeGradeChart() {
        const gradeDistribution = {};
        allCourses.forEach(course => {
            const gradePrefix = course.grade.charAt(0);
            gradeDistribution[gradePrefix] = (gradeDistribution[gradePrefix] || 0) + 1;
        });

        const ctx = document.getElementById('gradeChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(gradeDistribution).sort().reverse(),
                datasets: [{
                    data: Object.values(gradeDistribution),
                    backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('courseSearch').addEventListener('input', filterCourses);
        document.getElementById('semesterFilter').addEventListener('change', filterCourses);
        document.getElementById('gradeFilter').addEventListener('change', filterCourses);
    }

    function filterCourses() {
        const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
        const semesterFilter = document.getElementById('semesterFilter').value;
        const gradeFilter = document.getElementById('gradeFilter').value;

        let filtered = allCourses.filter(course => {
            const matchSearch = course.code.toLowerCase().includes(searchTerm) || 
                              course.name.toLowerCase().includes(searchTerm);
            const matchSemester = !semesterFilter || course.semesterId === semesterFilter;
            const matchGrade = !gradeFilter || course.grade.startsWith(gradeFilter);
            return matchSearch && matchSemester && matchGrade;
        });

        renderTranscriptTable(filtered);
    }

    function printTranscript() {
        window.print();
    }

    function downloadTranscript() {
        const element = document.querySelector('.cr-content');
        const opt = {
            margin: 10,
            filename: `transcript-${transcriptData.student.id}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };
        
        // Note: Requires html2pdf library
        alert('PDF download feature requires html2pdf library. Install via: npm install html2pdf.js');
    }

    async function handleLogout() {
        try {
            const response = await fetch('/auth/logout', { method: 'POST' });
            if (response.ok) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Logout error:', error);
            window.location.href = '/login';
        }
    }
</script>
</body>
</html>

